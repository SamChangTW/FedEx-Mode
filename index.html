<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FedEx 模式｜OCR 商業發票 v1.7M-F-W-R2</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css" />
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }
  </script>
</head>
<body class="theme-scheduler tsaa-layout">
  <header>
    <h1>商業發票（OCR）</h1>
    <div class="sub">v1.7M-F-W-R2 · 手機版 · 鈦灰 × 香檳金</div>
  </header>

  <main>
    <section class="tsaa-card">
      <h2>1) 取像與文字</h2>
      <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap;">
        <!-- 使用 label for 觸發原生相機選單，避免部分瀏覽器攔截對隱藏 input 的程式化點擊 -->
        <label id="btnCameraText" for="photoInput" role="button" class="tsaa-btn">
          啟動相機（拍照取文字）
        </label>
        <button id="btnRunNER" type="button" class="tsaa-btn">使用文字智能帶入（NER）</button>
        <small id="textExtractStatus" style="opacity:.8"></small>
      </div>
      <!-- 將 input 隱藏改為視覺隱藏（不使用 display:none），避免某些瀏覽器無法彈出相機選單 -->
      <input id="photoInput" type="file" accept="image/*" capture="environment" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;" />
      <textarea id="rawText" rows="5" placeholder="將從相片擷取的文字會顯示在此，或可直接貼上（標籤、AWB、發票或螢幕截圖文字）"></textarea>
      <small style="display:block;opacity:.7;margin-top:4px;line-height:1.4;">
        說明：本流程改為「拍照 → 取文字 → NER 智能解析」。若裝置支援 TextDetector 將離線識別，否則使用輕量 OCR 後再解析。
      </small>
    </section>

    <section class="tsaa-card">
      <h2>2) 欄位確認</h2>
      <div class="grid">
        <label>AWB 編號
          <input id="awb" inputmode="numeric" placeholder="例如：772165000095" />
        </label>
        <label>發票日期
          <input id="date" placeholder="YYYY-MM-DD" />
        </label>
        <label class="full">寄件人（Sender）
          <input id="seller" placeholder="公司名稱或姓名" />
        </label>
        <label class="full">寄件人地址（Sender Address）
          <textarea id="sellerAddr" placeholder="街道與門牌號、城市、州/省、郵遞區號、國家" rows="2"></textarea>
        </label>
        <label class="full">收件人（Recipient）
          <input id="buyer" placeholder="公司名稱或姓名" />
        </label>
        <label class="full">收件人地址（Recipient Address）
          <textarea id="buyerAddr" placeholder="街道與門牌號、城市、州/省、郵遞區號、國家" rows="2"></textarea>
        </label>
        <label>國家（Country）
          <input id="country" placeholder="例如：Taiwan / 美國 / JP / TW" />
        </label>
        <label>郵遞區號（Postal Code）
          <input id="postalCode" placeholder="例如：100、90210、10110" />
        </label>
        <label>電話（Phone）
          <input id="phone" placeholder="例如：+886 912345678" />
        </label>
        <label class="full">貨品說明（Description）
          <input id="desc" placeholder="例如：Paperboard Box" />
        </label>
        <label>金額（Amount / USD）
          <input id="amount" type="number" step="0.01" placeholder="數字，例如：120.00" />
        </label>
        <label>重量（Weight）
          <input id="weight" placeholder="例如：0.50 KG 或 1 LB" />
        </label>
        <label>件數（Pieces）
          <input id="pieces" inputmode="numeric" placeholder="例如：1" />
        </label>
      </div>
      <div class="row">
        <button id="btnClear" type="button" class="tsaa-btn">清空欄位</button>
      </div>
    </section>

    <section class="tsaa-card">
      <h2>3) 輸出</h2>
      <div class="row">
        <button id="btnPdf" type="button" class="tsaa-btn">生成 PDF（制式表格）</button>
        <span id="outStatus"></span>
      </div>
      <div class="row">
        <label style="display:flex;align-items:center;gap:8px;">
          <input id="useFedExTpl" type="checkbox" checked /> 使用 FedEx 官方版型（背景疊字）
        </label>
      </div>
      <div class="row" id="tplRow" style="display:flex;gap:8px;align-items:center;">
        <input id="tplInput" type="file" accept="image/png, image/jpeg, application/pdf" />
        <small>可上傳模板（PDF/PNG/JPG）。若留空，將嘗試載入 assets/ci_template.pdf 或 assets/ci_template.png</small>
      </div>
    </section>
  </main>

  <footer>
    <small>Public template · 無簽名 · 無 Logo · 僅必要欄位 · 可離線使用（PWA）</small>
  </footer>

  <!-- 已移除 tesseract.js 與 QR/條碼掃描庫（ZXing）。改用輕量 OCR 與 NER。 -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- 輕量 OCR：ocrad.js（用於無 TextDetector 的裝置） -->
  <script src="https://unpkg.com/ocrad.js/ocrad.min.js"></script>
  <!-- 加上版本參數以避免舊版快取（與 SW 的新規則相呼應） -->
  <script src="main.js?v=ner-r1"></script>
  <!-- TSAA design system: tokens, theme loader, and scheduler components -->
  <link rel="stylesheet" href="ui/tsaa_tokens.css" />
  <link rel="stylesheet" href="ui/scheduler.css" />
  <script src="ui/theme-loader.js"></script>
</body>
</html>
